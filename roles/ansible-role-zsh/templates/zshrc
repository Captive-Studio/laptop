
## Operating system detection
OS_FAMILY=Unknown
if [[ "$OSTYPE" == "linux-gnu" ]]; then
  OS_DISTRIBUTION=$(cat /etc/*-release | grep -w NAME | cut -d= -f2 | tr -d '"')

  case "$OS_DISTRIBUTION" in
  "RedHat" | "Fedora" | "CentOS" | "SLC" | "Amazon")
      OS_FAMILY=RedHat
      ;;
  "Ubuntu" | "Debian" | "Mint" | "SteamOS")
      OS_FAMILY=Debian
      ;;
  esac

elif [[ "$OSTYPE" == "darwin"* ]]; then
  OS_FAMILY=Darwin
else
  # Unknown.
fi

## Functions

-zplug-prefix () {
  if [[ $OS_FAMILY == "Debian" ]]; then
    echo "/usr/share/zplug"
  elif [[ $OS_FAMILY == "Darwin" ]]; then
    echo "/usr/local/opt/zplug"
  else
    echo "$HOME/.zplug"
  fi
}

-zplug-load () {
  if ! zplug check; then
    zplug install
  fi
  # source plugins and add commands to the PATH
  zplug load
}

-zplug-failed () {
  COMMAND_HINT='Try to install it.'
  if [[ $OS_FAMILY == "Darwin" ]]; then
    COMMAND_HINT="Try `brew install zplug`"
  elif [[ $OS_FAMILY == "Debian" ]]; then
    COMMAND_HINT="Try `sudo apt install zplug`"
  fi
  echo "zplug not found. $COMMAND_HINT"
}

-zsh-load-plugins() {
  ## Load everything in .zshrc.d/
  if [[ -d "$_ZSH_PLUGINS/" ]]; then
    for i in $(find "$_ZSH_PLUGINS/" -maxdepth 1 -type f -name "*.sh");
    do
      . $i;
    done
  fi
}

-zsh-jenv-load() {
  # Support for rbenv
  if which jenv > /dev/null; then eval "$(jenv init -)"; fi
}
-zsh-rbenv-load() {
  # Support for rbenv
  if which rbenv > /dev/null; then eval "$(rbenv init -)"; fi
}

## Load ZPlug
export ZPLUG_HOME="$HOME/.zplug"
_ZPLUG_PREFIX=$(-zplug-prefix)
_ZSH_PLUGINS="$HOME/.zshrc.d"

if [[ -f "$_ZPLUG_PREFIX/init.zsh" ]];then
  source "$_ZPLUG_PREFIX/init.zsh"

  # Launch zplug self manager plugin
  zplug "zplug/zplug", hook-build:'zplug --self-manage'

  # Load theme file
  zplug mafredri/zsh-async, from:github
  zplug sindresorhus/pure, use:pure.zsh, from:github, as:theme

  # Load Plugins
  zplug "zsh-users/zsh-autosuggestions"
  zplug "zsh-users/zsh-completions"
  zplug "zsh-users/zsh-syntax-highlighting", defer:2
  zplug "zsh-users/zsh-history-substring-search", defer:3
  zplug "modules/completion", from:prezto
  zplug "modules/spectrum", from:prezto
  # zplug "$_ZSH_PLUGINS", from:local

  -zsh-load-plugins
  -zplug-load
else
  -zplug-failed
  -zsh-load-plugins
fi;

# Load rbenv; jenv, ...
-zsh-rbenv-load
-zsh-jenv-load

# Improve PATH with local/bin
if [ -d ~/.local/bin/ ]; then
  export PATH=$PATH:~/.local/bin/
fi
